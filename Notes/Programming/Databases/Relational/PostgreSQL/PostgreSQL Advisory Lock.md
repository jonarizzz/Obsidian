**PostgreSQL Advisory Lock** – это механизм, который позволяет блокировать произвольные ресурсы в [[База данных (БД, Database, DB)||базе данных]], используя числовые ключи, без привязки к конкретным строкам [[Таблица БД (Database Table, DB Table)||таблицы]].


### Основные особенности:

- Не блокирует сами данные, а работает на уровне приложения.
- Подходит для [[Микросервис (Microservice)||микросервисов]], когда нельзя использовать [[Синтаксис SELECT ...  FOR UPDATE||SELECT ... FOR UPDATE]].
- Может применяться для предотвращения двойных операций (например, списания денег).


### Основные команды

**Захват блокировки (ожидает, пока она освободится)**

```sql
SELECT pg_advisory_lock(12345);
```

Если другая транзакция уже держит эту блокировку, запрос будет ждать.


**Проверка блокировки без ожидания**

```sql
SELECT pg_try_advisory_lock(12345);
```

Возвращает true, если блокировка получена, или false, если ресурс уже заблокирован.


**Освобождение блокировки**

```sql
SELECT pg_advisory_unlock(12345);
```

Освобождает блокировку вручную.


### Автоматическое снятие

Блокировка автоматически снимается при [[{TODO} Подтверждение Транзакции (Фиксирование Транзакции, Commit Transaction)||COMMIT]], [[Откат Транзакции (Rollback)||ROLLBACK]] или закрытии сессии.


### Пример: защита от двойного списания денег

Допустим, у нас есть сервис платежей, и нам нужно исключить повторное списание средств по одной [[Транзакция (Transaction)||транзакции]].

```sql
BEGIN;

-- Пробуем заблокировать ID транзакции (например, 98765)
SELECT pg_try_advisory_lock(98765);

-- Если блокировка получена, продолжаем обработку
UPDATE accounts SET balance = balance - 100 WHERE id = 1;

-- Фиксируем изменения
COMMIT;

-- Освобождаем блокировку
SELECT pg_advisory_unlock(98765);
```

Если кто-то попытается обработать ту же [[Транзакция (Transaction)||транзакцию]], он не сможет взять блокировку и выполнит retry позже.


### Когда использовать

- Для предотвращения [[Гонки Данных (Data Races)||гонок данных]] в [[Микросервис (Microservice)||микросервисах]].
- Для защиты от дублирующихся [[Транзакция (Transaction)||транзакций]].
- Для координации работы нескольких процессов.