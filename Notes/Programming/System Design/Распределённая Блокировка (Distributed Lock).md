**Распределённая блокировка (Distributed Lock)** — это механизм синхронизации, который позволяет координировать доступ к разделяемым ресурсам (например, [[{TODO} Файл (File)||файлам]], [[База данных (БД, Database, DB)||базам данных]], [[API (Application Programming Interface)||API]]) в [[Распределённая Система (Distributed System)||распределённых системах]].

В отличие от обычных локальных блокировок, которые применяются на уровне одной машины (например, с помощью [[Синтаксис SELECT ...  FOR UPDATE||SELECT ... FOR UPDATE]] в [[База данных (БД, Database, DB)||базе данных]]), распределённая блокировка используется, когда несколько процессов или [[Микросервис (Microservice)||микросервисов]] работают на разных машинах или в разных [[{TODO} Docker Container||контейнерах]].


### Зачем нужна

- Для координации действий между несколькими экземплярами приложений (например, один процесс должен обновить данные, а другие должны ожидать завершения).
- Для избежания конфликтов при доступе к общим ресурсам (например, при одновременном обновлении данных в [[База данных (БД, Database, DB)||базе]]).
- Для управления исключениями и предотвращения одновременных операций (например, два разных сервиса не должны одновременно обрабатывать одну задачу).


### Как работает

- Захват блокировки – процесс или сервис получает доступ к ресурсу, “захватывая” блокировку. Это блокирует остальные процессы от работы с этим ресурсом.
- Проверка блокировки – если ресурс уже заблокирован, то другие процессы должны либо ожидать, либо проверить через заданные интервалы (retry), можно ли заблокировать его позже.
- Освобождение блокировки – после завершения операции с ресурсом блокировка освобождается, и другие процессы могут захватить ресурс.


### Пример использования

Предположим, у нас есть [[Микросервис (Microservice)||микросервисы]], которые выполняют операции по обработке заказов. Нам нужно гарантировать, чтобы один заказ не был обработан одновременно несколькими сервисами. В этом случае мы используем [[Распределённая Блокировка (Distributed Lock)||распределённую блокировку]].

- Сервисы используют систему блокировок (например, [[{TODO} Redis||Redis]]) для захвата блокировки по ID заказа.
- Пока сервис захватывает блокировку для конкретного заказа, другие сервисы, пытающиеся захватить ту же блокировку, будут ожидать, пока она не освободится.
- После завершения обработки заказа блокировка освобождается.


### Когда использовать

- Для синхронизации операций между несколькими [[Микросервис (Microservice)||микросервисами]]: Например, если несколько сервисов обращаются к одной и той же [[База данных (БД, Database, DB)||базе данных]] или ресурсу.
- Для ограничения одновременного доступа к ресурсам, таким как [[API (Application Programming Interface)||API]], [[{TODO} Файл (File)||файлы]], или внешние сервисы.
- Для предотвращения [[Гонки Данных (Data Races)||гонок данных]]: Когда важно, чтобы только один процесс обрабатывал данные одновременно.
- Для гарантии выполнения одной операции в [[Распределённая Система (Distributed System)||распределённой среде]]: Например, обработка платежа, резервирование ресурсов.


### Примеры инструментов для распределённых блокировок

- [[{TODO} Redis||Redis]] – используется с SETNX или библиотеками вроде [[{TODO} Redlock||Redlock]] для многократных узлов.
- [[Kafka Zookeeper||Zookeeper]] – платформа, которая предоставляет решения для распределённых блокировок и координации.
- **etcd** – механизм для распределённого хранения конфигураций и управления блокировками.
- **Consul** – используется для распределённых сервисов и управления их состоянием, включая блокировки.
